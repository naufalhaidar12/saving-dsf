<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings E-Wallet Application</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .landing-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .landing-content {
            text-align: center;
        }

        .landing-content h1 {
            font-size: 3.5rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 1.5rem;
        }

        .landing-content p {
            font-size: 1.25rem;
            color: #6c757d;
            margin-bottom: 2rem;
        }

        .btn-enter {
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 50px;
            background-color: #212529;
            border: none;
            transition: all 0.3s;
        }

        .btn-enter:hover {
            background-color: #495057;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-app {
            display: none;
        }

        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .navbar-brand {
            font-weight: 700;
            color: #212529 !important;
            font-size: 1.5rem;
        }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }

        .nav-tabs .nav-link:hover {
            border: none;
            background-color: #f8f9fa;
        }

        .nav-tabs .nav-link.active {
            color: #212529;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid #212529;
        }

        .stat-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            background-color: #ffffff;
        }

        .stat-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: #6c757d;
            font-size: 1rem;
            margin-bottom: 0;
        }

        .card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }

        .table {
            background-color: #ffffff;
        }

        .table thead th {
            background-color: #212529;
            color: #ffffff;
            border: none;
            font-weight: 600;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .btn-primary {
            background-color: #212529;
            border: none;
        }

        .btn-primary:hover {
            background-color: #495057;
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-title {
            color: #212529;
            font-weight: 700;
        }

        .transfer-card {
            max-width: 600px;
            margin: 0 auto;
        }

        .transfer-icon {
            font-size: 3rem;
            color: #212529;
            margin-bottom: 1rem;
        }

        .account-info-card {
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            background-color: #f8fff9;
        }

        .account-info-card.error {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        .bank-logo {
            font-size: 2rem;
            margin-right: 10px;
        }

        .transaction-item {
            border-left: 3px solid #212529;
            padding-left: 15px;
            margin-bottom: 15px;
        }

        .transaction-item.incoming {
            border-left-color: #28a745;
        }

        .transaction-item.outgoing {
            border-left-color: #dc3545;
        }

        .badge-bank {
            font-size: 0.9rem;
            padding: 5px 10px;
        }
    </style>
</head>
<body>

<!-- Landing Page -->
<div id="landingPage" class="landing-page">
    <div class="container">
        <div class="landing-content">
            <i class="fas fa-wallet fa-5x mb-4" style="color: #212529;"></i>
            <h1>E-Wallet Savings</h1>
            <p class="lead">Manage your money transfers and savings efficiently</p>
            <button class="btn btn-dark btn-enter" onclick="enterApp()">
                <i class="fas fa-arrow-right me-2"></i>Enter Application
            </button>
        </div>
    </div>
</div>

<!-- Main Application -->
<div id="mainApp" class="main-app">
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-wallet me-2"></i>E-Wallet Savings
            </a>
            <button class="btn btn-outline-dark btn-sm" onclick="exitApp()">
                <i class="fas fa-sign-out-alt me-2"></i>Exit
            </button>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div id="alertContainer"></div>

        <div class="text-center my-4 d-none" id="loading">
            <div class="spinner-border text-dark" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#dashboard" onclick="loadDashboard()">
                    <i class="fas fa-chart-line me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#customers">
                    <i class="fas fa-users me-2"></i>Customers
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#savings">
                    <i class="fas fa-piggy-bank me-2"></i>Accounts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#transfer">
                    <i class="fas fa-exchange-alt me-2"></i>Transfer
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#history" onclick="loadTransactionHistory()">
                    <i class="fas fa-history me-2"></i>History
                </a>
            </li>
        </ul>

        <div class="tab-content mt-4">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane fade show active">
                <h2 class="mb-4">Dashboard Overview</h2>
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-users fa-2x mb-3" style="color: #212529;"></i>
                            <h3 id="totalCustomers">0</h3>
                            <p>Total Customers</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-wallet fa-2x mb-3" style="color: #212529;"></i>
                            <h3 id="totalSavings">0</h3>
                            <p>Total Accounts</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave fa-2x mb-3" style="color: #212529;"></i>
                            <h3 id="totalBalance">Rp 0</h3>
                            <p>Total Balance</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-exchange-alt fa-2x mb-3" style="color: #212529;"></i>
                            <h3 id="totalTransactions">0</h3>
                            <p>Transactions</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentTransactions"></div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="tab-pane fade">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Customer Management</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="showCustomerModal()">
                            <i class="fas fa-plus me-2"></i>Add Customer
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchCustomer" placeholder="Search by name, email, or government ID..." onkeyup="searchCustomers()">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Government ID</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="customerTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings Tab -->
            <div id="savings" class="tab-pane fade">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Account Management</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#savingModal" onclick="showSavingModal()">
                            <i class="fas fa-plus me-2"></i>Add Account
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchSaving" placeholder="Search by name or account number..." onkeyup="searchSavings()">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Account Number</th>
                                    <th>Bank</th>
                                    <th>Balance</th>
                                    <th>Customer</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="savingTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transfer Tab -->
            <div id="transfer" class="tab-pane fade">
                <div class="transfer-card">
                    <div class="card">
                        <div class="card-header text-center">
                            <i class="fas fa-exchange-alt transfer-icon"></i>
                            <h4 class="mb-0">Transfer Money</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="transferForm" onsubmit="processTransfer(event)">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-user me-2"></i>From Account Number *</label>
                                    <input type="text" class="form-control" id="transferFrom" required placeholder="Enter sender account number">
                                    <div id="senderAccountInfo"></div>
                                </div>

                                <div class="text-center mb-3">
                                    <i class="fas fa-arrow-down fa-2x text-muted"></i>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-user me-2"></i>To Account Number *</label>
                                    <input type="text" class="form-control" id="transferTo" required placeholder="Enter receiver account number">
                                    <div id="receiverAccountInfo"></div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-money-bill-wave me-2"></i>Amount *</label>
                                    <input type="number" step="0.01" class="form-control" id="transferAmount" required placeholder="Enter amount">
                                </div>

                                <div class="mb-4">
                                    <label class="form-label"><i class="fas fa-comment me-2"></i>Description (Optional)</label>
                                    <textarea class="form-control" id="transferDescription" rows="2" placeholder="Add a note..."></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary w-100" id="transferButton" disabled>
                                    <i class="fas fa-paper-plane me-2"></i>Transfer Now
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-pane fade">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Transaction History</h5>
                        <div>
                            <input type="text" class="form-control form-control-sm" id="searchHistory" placeholder="Search by account number..." onkeyup="searchHistory()">
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="historyContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm" onsubmit="saveCustomer(event)">
                    <input type="hidden" id="customerId">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Government ID *</label>
                        <input type="text" class="form-control" id="customerGovId" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="customerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone *</label>
                        <input type="text" class="form-control" id="customerPhone" required>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Saving Modal -->
<div class="modal fade" id="savingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savingModalTitle">Add Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="savingForm" onsubmit="saveSaving(event)">
                    <input type="hidden" id="savingId">
                    <div class="mb-3">
                        <label class="form-label">Account Name *</label>
                        <input type="text" class="form-control" id="savingName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account Number *</label>
                        <input type="text" class="form-control" id="savingAccountNumber" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bank Name *</label>
                        <select class="form-select" id="savingBankName" required>
                            <option value="">Select Bank</option>
                            <option value="BCA">BCA</option>
                            <option value="Mandiri">Mandiri</option>
                            <option value="BNI">BNI</option>
                            <option value="BRI">BRI</option>
                            <option value="CIMB Niaga">CIMB Niaga</option>
                            <option value="Permata">Permata</option>
                            <option value="Danamon">Danamon</option>
                            <option value="BTN">BTN</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Balance *</label>
                        <input type="number" step="0.01" class="form-control" id="savingBalance" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer *</label>
                        <select class="form-select" id="savingCustomer" required>
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'http://localhost:8080/api/v1';
    let customers = [];
    let savings = [];
    let allTransactions = [];
    let senderValid = false;
    let receiverValid = false;

    function enterApp() {
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadCustomers();
        loadSavings();
        loadDashboard();
    }

    function exitApp() {
        if (confirm('Are you sure you want to exit?')) {
            document.getElementById('landingPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
    }

    function showLoading() {
        document.getElementById('loading').classList.remove('d-none');
    }

    function hideLoading() {
        document.getElementById('loading').classList.add('d-none');
    }

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        alertContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        setTimeout(() => {
            alertContainer.innerHTML = '';
        }, 5000);
    }

    async function loadDashboard() {
        await loadCustomers();
        await loadSavings();
        await loadRecentTransactions();

        document.getElementById('totalCustomers').textContent = customers.length;
        document.getElementById('totalSavings').textContent = savings.length;

        const totalBalance = savings.reduce((sum, s) => sum + (s.balance || 0), 0);
        document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
    }

    async function loadRecentTransactions() {
        try {
            const response = await fetch(`${API_URL}/transaction-history/recent`);
            const transactions = await response.json();

            document.getElementById('totalTransactions').textContent = transactions.length;

            const container = document.getElementById('recentTransactions');
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No transactions yet</p>';
                return;
            }

            container.innerHTML = transactions.slice(0, 5).map(t => `
                <div class="transaction-item ${t.transactionType === 'TRANSFER' ? 'outgoing' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${t.senderName}</strong> ‚Üí <strong>${t.receiverName}</strong>
                            <br>
                            <small class="text-muted">
                                <span class="badge badge-bank bg-secondary">${t.senderBank}</span> ‚Üí
                                <span class="badge badge-bank bg-secondary">${t.receiverBank}</span>
                            </small>
                            ${t.description ? `<br><small class="text-muted">${t.description}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <strong class="text-danger">${formatCurrency(t.amount)}</strong>
                            <br>
                            <small class="text-muted">${formatDate(t.transactionDate)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Failed to load recent transactions:', error);
        }
    }

    async function loadCustomers() {
        try {
            showLoading();
            const response = await fetch(`${API_URL}/customer`);
            customers = await response.json();
            renderCustomers(customers);
            loadCustomerOptions();
        } catch (error) {
            showAlert('Failed to load customers: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function renderCustomers(data) {
        const tbody = document.getElementById('customerTableBody');
        tbody.innerHTML = data.map(customer => `
            <tr>
                <td>${customer.id}</td>
                <td>${customer.name}</td>
                <td>${customer.governmentId}</td>
                <td>${customer.email}</td>
                <td>${customer.phone}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer(${customer.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${customer.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function searchCustomers() {
        const query = document.getElementById('searchCustomer').value.toLowerCase();
        const filtered = customers.filter(c =>
            c.name.toLowerCase().includes(query) ||
            c.email.toLowerCase().includes(query) ||
            c.governmentId.toLowerCase().includes(query)
        );
        renderCustomers(filtered);
    }

    function showCustomerModal() {
        document.getElementById('customerModalTitle').textContent = 'Add Customer';
        document.getElementById('customerForm').reset();
        document.getElementById('customerId').value = '';
    }

    async function editCustomer(id) {
        const customer = customers.find(c => c.id === id);
        if (!customer) return;

        document.getElementById('customerModalTitle').textContent = 'Edit Customer';
        document.getElementById('customerId').value = customer.id;
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerGovId').value = customer.governmentId;
        document.getElementById('customerEmail').value = customer.email;
        document.getElementById('customerPhone').value = customer.phone;

        const modal = new bootstrap.Modal(document.getElementById('customerModal'));
        modal.show();
    }

    async function saveCustomer(event) {
        event.preventDefault();

        const id = document.getElementById('customerId').value;
        const data = {
            name: document.getElementById('customerName').value,
            governmentId: document.getElementById('customerGovId').value,
            email: document.getElementById('customerEmail').value,
            phone: document.getElementById('customerPhone').value
        };

        try {
            showLoading();
            let response;

            if (id) {
                response = await fetch(`${API_URL}/customer/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch(`${API_URL}/customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                showAlert(id ? 'Customer updated successfully!' : 'Customer created successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
                loadCustomers();
                loadDashboard();
            } else {
                showAlert('Failed to save customer', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function deleteCustomer(id) {
        if (!confirm('Are you sure you want to delete this customer?')) return;

        try {
            showLoading();
            const response = await fetch(`${API_URL}/customer/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('Customer deleted successfully!', 'success');
                loadCustomers();
                loadDashboard();
            } else {
                showAlert('Failed to delete customer', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function loadSavings() {
        try {
            showLoading();
            const response = await fetch(`${API_URL}/saving`);
            savings = await response.json();
            renderSavings(savings);
        } catch (error) {
            showAlert('Failed to load savings: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function renderSavings(data) {
        const tbody = document.getElementById('savingTableBody');
        tbody.innerHTML = data.map(saving => `
            <tr>
                <td>${saving.id}</td>
                <td>${saving.name}</td>
                <td>${saving.accountNumber}</td>
                <td>
                    <span class="bank-logo">${saving.bankLogo || 'üè¶'}</span>
                    <strong>${saving.bankName}</strong>
                </td>
                <td>${formatCurrency(saving.balance)}</td>
                <td>${saving.customer ? saving.customer.name : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editSaving(${saving.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSaving(${saving.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function searchSavings() {
        const query = document.getElementById('searchSaving').value.toLowerCase();
        const filtered = savings.filter(s =>
            s.name.toLowerCase().includes(query) ||
            s.accountNumber.toLowerCase().includes(query)
        );
        renderSavings(filtered);
    }

    function loadCustomerOptions() {
        const select = document.getElementById('savingCustomer');
        select.innerHTML = '<option value="">Select Customer</option>' +
            customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    function showSavingModal() {
        document.getElementById('savingModalTitle').textContent = 'Add Account';
        document.getElementById('savingForm').reset();
        document.getElementById('savingId').value = '';
        loadCustomerOptions();
    }

    async function editSaving(id) {
        const saving = savings.find(s => s.id === id);
        if (!saving) return;

        document.getElementById('savingModalTitle').textContent = 'Edit Account';
        document.getElementById('savingId').value = saving.id;
        document.getElementById('savingName').value = saving.name;
        document.getElementById('savingAccountNumber').value = saving.accountNumber;
        document.getElementById('savingBankName').value = saving.bankName;
        document.getElementById('savingBalance').value = saving.balance;
        document.getElementById('savingCustomer').value = saving.customer.id;

        const modal = new bootstrap.Modal(document.getElementById('savingModal'));
        modal.show();
    }

    async function saveSaving(event) {
        event.preventDefault();

        const id = document.getElementById('savingId').value;
        const customerId = document.getElementById('savingCustomer').value;
        const bankName = document.getElementById('savingBankName').value;

        const bankLogos = {
            'BCA': 'üè¶',
            'Mandiri': 'üè¶',
            'BNI': 'üè¶',
            'BRI': 'üè¶',
            'CIMB Niaga': 'üè¶',
            'Permata': 'üè¶',
            'Danamon': 'üè¶',
            'BTN': 'üè¶'
        };

        const data = {
            name: document.getElementById('savingName').value,
            accountNumber: document.getElementById('savingAccountNumber').value,
            bankName: bankName,
            bankLogo: bankLogos[bankName] || 'üè¶',
            balance: parseFloat(document.getElementById('savingBalance').value),
            customer: {
                id: parseInt(customerId)
            }
        };

        try {
            showLoading();
            let response;

            if (id) {
                response = await fetch(`${API_URL}/saving/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch(`${API_URL}/saving`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                showAlert(id ? 'Account updated successfully!' : 'Account created successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('savingModal')).hide();
                loadSavings();
                loadDashboard();
            } else {
                showAlert('Failed to save account', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function deleteSaving(id) {
        if (!confirm('Are you sure you want to delete this account?')) return;

        try {
            showLoading();
            const response = await fetch(`${API_URL}/saving/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('Account deleted successfully!', 'success');
                loadSavings();
                loadDashboard();
            } else {
                showAlert('Failed to delete account', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function validateSenderAccount() {
        const accountNumber = document.getElementById('transferFrom').value.trim();
        const infoDiv = document.getElementById('senderAccountInfo');

        if (!accountNumber) {
            infoDiv.innerHTML = '';
            senderValid = false;
            checkTransferButton();
            return;
        }

        try {
            const response = await fetch(`${API_URL}/validate-account/${accountNumber}`);
            const data = await response.json();

            if (data.valid) {
                infoDiv.innerHTML = `
                    <div class="account-info-card mt-2">
                        <div class="d-flex align-items-center">
                            <span class="bank-logo">${data.bankLogo}</span>
                            <div>
                                <strong>${data.accountName}</strong><br>
                                <small class="text-muted">${data.bankName} - ${data.accountNumber}</small>
                            </div>
                        </div>
                    </div>
                `;
                senderValid = true;
            } else {
                infoDiv.innerHTML = `
                    <div class="account-info-card error mt-2">
                        <small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${data.message}</small>
                    </div>
                `;
                senderValid = false;
            }
        } catch (error) {
            infoDiv.innerHTML = `
                <div class="account-info-card error mt-2">
                    <small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Failed to validate account</small>
                </div>
            `;
            senderValid = false;
        }

        checkTransferButton();
    }

    async function validateReceiverAccount() {
        const accountNumber = document.getElementById('transferTo').value.trim();
        const infoDiv = document.getElementById('receiverAccountInfo');

        if (!accountNumber) {
            infoDiv.innerHTML = '';
            receiverValid = false;
            checkTransferButton();
            return;
        }

        try {
            const response = await fetch(`${API_URL}/validate-account/${accountNumber}`);
            const data = await response.json();

            if (data.valid) {
                infoDiv.innerHTML = `
                    <div class="account-info-card mt-2">
                        <div class="d-flex align-items-center">
                            <span class="bank-logo">${data.bankLogo}</span>
                            <div>
                                <strong>${data.accountName}</strong><br>
                                <small class="text-muted">${data.bankName} - ${data.accountNumber}</small>
                            </div>
                        </div>
                    </div>
                `;
                receiverValid = true;
            } else {
                infoDiv.innerHTML = `
                    <div class="account-info-card error mt-2">
                        <small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${data.message}</small>
                    </div>
                `;
                receiverValid = false;
            }
        } catch (error) {
            infoDiv.innerHTML = `
                <div class="account-info-card error mt-2">
                    <small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Failed to validate account</small>
                </div>
            `;
            receiverValid = false;
        }

        checkTransferButton();
    }

    function checkTransferButton() {
        const button = document.getElementById('transferButton');
        const amount = document.getElementById('transferAmount').value;

        if (senderValid && receiverValid && amount && parseFloat(amount) > 0) {
            button.disabled = false;
        } else {
            button.disabled = true;
        }
    }

    async function processTransfer(event) {
        event.preventDefault();

        const data = {
            nomorRekeningPengirim: document.getElementById('transferFrom').value,
            nomorRekeningPenerima: document.getElementById('transferTo').value,
            nominal: parseFloat(document.getElementById('transferAmount').value),
            description: document.getElementById('transferDescription').value
        };

        try {
            showLoading();
            const response = await fetch(`${API_URL}/transfer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Transfer successful!', 'success');
                document.getElementById('transferForm').reset();
                document.getElementById('senderAccountInfo').innerHTML = '';
                document.getElementById('receiverAccountInfo').innerHTML = '';
                senderValid = false;
                receiverValid = false;
                checkTransferButton();
                loadSavings();
                loadDashboard();
            } else {
                showAlert(result.message, 'error');
            }
        } catch (error) {
            showAlert('Transfer failed: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function loadTransactionHistory() {
        try {
            showLoading();
            const response = await fetch(`${API_URL}/transaction-history`);
            allTransactions = await response.json();
            renderTransactionHistory(allTransactions);
        } catch (error) {
            showAlert('Failed to load transaction history: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function renderTransactionHistory(transactions) {
        const container = document.getElementById('historyContainer');

        if (transactions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No transaction history found</p>';
            return;
        }

        container.innerHTML = transactions.map(t => `
            <div class="transaction-item ${t.transactionType === 'TRANSFER' ? 'outgoing' : ''}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-2">
                            <span class="badge bg-dark">${t.transactionType}</span>
                            <span class="badge ${t.status === 'SUCCESS' ? 'bg-success' : 'bg-danger'}">${t.status}</span>
                        </div>
                        <div class="mb-2">
                            <strong>From:</strong> ${t.senderName}
                            <span class="badge badge-bank bg-secondary">${t.senderBank}</span>
                            <br>
                            <small class="text-muted">${t.senderAccountNumber}</small>
                        </div>
                        <div class="mb-2">
                            <strong>To:</strong> ${t.receiverName}
                            <span class="badge badge-bank bg-secondary">${t.receiverBank}</span>
                            <br>
                            <small class="text-muted">${t.receiverAccountNumber}</small>
                        </div>
                        ${t.description ? `<div class="mb-2"><small class="text-muted"><i class="fas fa-comment me-1"></i>${t.description}</small></div>` : ''}
                    </div>
                    <div class="col-md-4 text-end">
                        <h4 class="mb-2 text-danger">${formatCurrency(t.amount)}</h4>
                        <small class="text-muted">${formatDate(t.transactionDate)}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function searchHistory() {
        const query = document.getElementById('searchHistory').value.toLowerCase();
        const filtered = allTransactions.filter(t =>
            t.senderAccountNumber.includes(query) ||
            t.receiverAccountNumber.includes(query) ||
            t.senderName.toLowerCase().includes(query) ||
            t.receiverName.toLowerCase().includes(query)
        );
        renderTransactionHistory(filtered);
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('id-ID', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }).format(date);
    }

    // Initialize event listeners on page load
    window.addEventListener('load', function() {
        const transferFrom = document.getElementById('transferFrom');
        const transferTo = document.getElementById('transferTo');
        const transferAmount = document.getElementById('transferAmount');

        if (transferFrom) {
            transferFrom.addEventListener('blur', validateSenderAccount);
            transferFrom.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    document.getElementById('senderAccountInfo').innerHTML = '';
                    senderValid = false;
                    checkTransferButton();
                }
            });
        }

        if (transferTo) {
            transferTo.addEventListener('blur', validateReceiverAccount);
            transferTo.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    document.getElementById('receiverAccountInfo').innerHTML = '';
                    receiverValid = false;
                    checkTransferButton();
                }
            });
        }

        if (transferAmount) {
            transferAmount.addEventListener('input', checkTransferButton);
        }

        // Prevent negative values in number inputs
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === '-' || e.key === '+') {
                    e.preventDefault();
                }
            });
        });
    });
</script>
</body>
</html>